// Primary database schema - Tenant registry and platform metadata
// This schema is owned by the API Gateway (vritti-api-nexus)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("PRISMA_CLI_DATABASE_URL")
  directUrl = env("PRISMA_CLI_DIRECT_URL")
}

/// Tenant registry - stores configuration for all tenants
model Tenant {
  id          String       @id @default(uuid())
  subdomain   String       @unique /// Subdomain for tenant access (e.g., 'acme' for acme.yourdomain.com)
  name        String       /// Display name
  description String?      /// Optional description of the tenant

  dbType   DatabaseType @default(SHARED) @map("db_type")
  status   TenantStatus @default(ACTIVE)

  // Relationship to database configuration (one-to-one)
  // SHARED tenants typically don't have a database config
  // DEDICATED tenants have their own database configuration
  databaseConfig TenantDatabaseConfig?

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("tenants")
}

/// Tenant database configuration - stores database connection details
/// This table contains sensitive information and should be encrypted at rest
model TenantDatabaseConfig {
  id String @id @default(uuid())

  // Foreign key relationship (one-to-one)
  tenantId String @unique @map("tenant_id")
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Database connection details
  dbHost             String  @map("db_host") /// Database host
  dbPort             Int     @map("db_port") /// Database port (e.g., 5432 for PostgreSQL)
  dbUsername         String  @map("db_username") /// Database username
  dbPassword         String  @map("db_password") /// Database password (TODO: Encrypt before storing)
  dbName             String  @map("db_name") /// Database name
  dbSchema           String? @map("db_schema") /// PostgreSQL schema name (optional)
  dbSslMode          String  @default("require") @map("db_ssl_mode") /// SSL mode: require, prefer, disable
  connectionPoolSize Int     @default(10) @map("connection_pool_size") /// Connection pool size

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("tenant_database_configs")
}

enum DatabaseType {
  SHARED    /// Shared database with separate schema per tenant
  DEDICATED /// Dedicated database per tenant
}

enum TenantStatus {
  ACTIVE    /// Tenant is active and can be accessed
  SUSPENDED /// Tenant is temporarily suspended
  ARCHIVED  /// Tenant is archived (soft delete)
}

// ============================================
// USER ONBOARDING & AUTHENTICATION MODELS
// ============================================

/// User account - core user entity
model User {
  id        String @id @default(uuid())
  email     String @unique
  firstName String? @map("first_name")
  lastName  String? @map("last_name")

  // Authentication
  passwordHash String? @map("password_hash") /// Nullable for OAuth-only users

  // Account status tracking
  accountStatus      AccountStatus  @default(PENDING_VERIFICATION) @map("account_status")
  emailVerified      Boolean        @default(false) @map("email_verified")
  phoneVerified      Boolean        @default(false) @map("phone_verified")
  onboardingStep     OnboardingStep @default(EMAIL_VERIFICATION) @map("onboarding_step")
  onboardingComplete Boolean        @default(false) @map("onboarding_complete")

  // Phone number (optional, added during mobile verification)
  phone        String? /// E.164 format (e.g., +1234567890)
  phoneCountry String? @map("phone_country") /// ISO country code (e.g., US, IN)

  // Profile
  profilePictureUrl String? @map("profile_picture_url")
  locale            String  @default("en") /// User's preferred language
  timezone          String  @default("UTC")

  // Relationships
  emailVerifications  EmailVerification[]
  mobileVerifications MobileVerification[]
  twoFactorAuth       TwoFactorAuth[]
  oauthProviders      OAuthProvider[]
  sessions            Session[]

  // Metadata
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")
  emailVerifiedAt DateTime? @map("email_verified_at")
  phoneVerifiedAt DateTime? @map("phone_verified_at")

  @@map("users")
}

/// Email verification - tracks OTP for email verification
model EmailVerification {
  id String @id @default(uuid())

  // Foreign key
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // OTP details
  email      String /// Email address being verified
  otp        String /// 6-digit OTP (hashed)
  attempts   Int    @default(0) /// Failed verification attempts
  isVerified Boolean @default(false) @map("is_verified")

  // Expiry
  expiresAt DateTime @map("expires_at") /// OTP expiration time (5 minutes)

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  verifiedAt DateTime? @map("verified_at")

  @@index([userId, email])
  @@map("email_verifications")
}

/// Mobile verification - tracks OTP and QR verification for phone numbers
model MobileVerification {
  id String @id @default(uuid())

  // Foreign key
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Phone details
  phone        String /// E.164 format
  phoneCountry String @map("phone_country") /// ISO country code

  // Verification method
  method VerificationMethod /// WHATSAPP_QR, SMS_QR, MANUAL_OTP

  // OTP details (for MANUAL_OTP method)
  otp        String? /// 6-digit OTP (hashed)
  attempts   Int     @default(0)
  isVerified Boolean @default(false) @map("is_verified")

  // QR code details (for QR methods)
  qrCode         String?   @map("qr_code") /// Base64 QR code image
  qrScannedAt    DateTime? @map("qr_scanned_at")
  qrVerificationId String?   @unique @map("qr_verification_id") /// Unique ID for webhook callbacks

  // Expiry
  expiresAt DateTime @map("expires_at")

  // Metadata
  createdAt  DateTime  @default(now()) @map("created_at")
  verifiedAt DateTime? @map("verified_at")

  @@index([userId, phone])
  @@index([qrVerificationId])
  @@map("mobile_verifications")
}

/// Two-factor authentication - stores 2FA settings
model TwoFactorAuth {
  id String @id @default(uuid())

  // Foreign key
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 2FA method
  method   TwoFactorMethod
  isActive Boolean         @default(true) @map("is_active")

  // TOTP (Authenticator App) details
  totpSecret String? @map("totp_secret") /// Base32 encoded secret
  totpBackupCodes String? @map("totp_backup_codes") /// Comma-separated encrypted backup codes

  // Passkey (WebAuthn) details
  passkeyCredentialId String? @unique @map("passkey_credential_id")
  passkeyPublicKey    String? @map("passkey_public_key")
  passkeyCounter      Int?    @map("passkey_counter")

  // Metadata
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastUsedAt   DateTime? @map("last_used_at")

  @@index([userId, method])
  @@map("two_factor_auth")
}

/// OAuth provider - links external OAuth providers to user accounts
model OAuthProvider {
  id String @id @default(uuid())

  // Foreign key
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Provider details
  provider   OAuthProviderType
  providerId String            @map("provider_id") /// Unique ID from OAuth provider

  // Provider data
  email         String?
  displayName   String? @map("display_name")
  profilePictureUrl String? @map("profile_picture_url")
  accessToken   String? @map("access_token") /// Encrypted
  refreshToken  String? @map("refresh_token") /// Encrypted
  tokenExpiresAt DateTime? @map("token_expires_at")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([provider, providerId])
  @@index([userId, provider])
  @@map("oauth_providers")
}

/// Session - tracks active user sessions with access and refresh tokens
model Session {
  id String @id @default(uuid())

  // Foreign key
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Token details
  accessToken  String   @unique @map("access_token") /// JWT access token
  refreshToken String   @unique @map("refresh_token") /// JWT refresh token
  tokenType    String   @default("Bearer") @map("token_type")

  // Session metadata
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  isActive  Boolean  @default(true) @map("is_active")

  // Expiry
  accessTokenExpiresAt  DateTime @map("access_token_expires_at")
  refreshTokenExpiresAt DateTime @map("refresh_token_expires_at")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId, isActive])
  @@index([accessToken])
  @@index([refreshToken])
  @@map("sessions")
}

// ============================================
// ENUMS FOR USER ONBOARDING & AUTH
// ============================================

enum AccountStatus {
  PENDING_VERIFICATION /// Email verification pending
  PENDING_MOBILE       /// Mobile verification pending
  ACTIVE               /// Account fully activated
  SUSPENDED            /// Account suspended by admin
  DEACTIVATED          /// Account deactivated by user
}

enum OnboardingStep {
  EMAIL_VERIFICATION    /// Step 1: Verify email
  SET_PASSWORD          /// Step 1b: Set password (OAuth users only)
  MOBILE_VERIFICATION   /// Step 2: Verify phone number
  TWO_FACTOR_SETUP      /// Step 3: Setup 2FA (optional)
  COMPLETE              /// Onboarding complete
}

enum VerificationMethod {
  WHATSAPP_QR /// Verify via WhatsApp QR code
  SMS_QR      /// Verify via SMS QR code
  MANUAL_OTP  /// Manually enter phone and receive OTP
}

enum TwoFactorMethod {
  TOTP    /// Time-based OTP (Authenticator App)
  PASSKEY /// WebAuthn Passkey
}

enum OAuthProviderType {
  GOOGLE
  MICROSOFT
  APPLE
  FACEBOOK
  X
}

/// OAuth state tokens - for CSRF protection in OAuth flows
/// Used for database-backed OAuth state management (instead of Redis)
model OAuthState {
  id String @id @default(uuid())

  // State token (random, signed)
  stateToken String @unique @map("state_token")

  // Provider and optional user context
  provider OAuthProviderType
  userId   String?         @map("user_id") /// For "link provider" flows

  // PKCE (OAuth 2.1)
  codeVerifier String @map("code_verifier")

  // Expiry (10 minutes TTL)
  expiresAt DateTime @map("expires_at")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")

  @@index([stateToken])
  @@index([expiresAt]) // For cleanup queries
  @@map("oauth_states")
}
